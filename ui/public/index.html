<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üß† Memory Explorer</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#1a1a2e;--surface:#16213e;--card:#0f3460;--border:#1a4a7a;--text:#e0e0e0;--muted:#8899aa;--accent:#e94560;--accent2:#0ea5e9}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
a{color:var(--accent2)}

.header{background:var(--surface);border-bottom:1px solid var(--border);padding:16px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.header h1{font-size:1.4rem;font-weight:700}
.header .stats{color:var(--muted);font-size:.9rem}

.container{max-width:1200px;margin:0 auto;padding:20px}

.search-bar{display:flex;gap:10px;margin-bottom:20px}
.search-bar input{flex:1;padding:12px 16px;border:1px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text);font-size:1rem;outline:none}
.search-bar input:focus{border-color:var(--accent2)}
.search-bar button{padding:12px 24px;border:none;border-radius:8px;background:var(--accent2);color:#fff;cursor:pointer;font-size:1rem;font-weight:600}
.search-bar button:hover{opacity:.9}

.filters{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.filters button{padding:6px 14px;border:1px solid var(--border);border-radius:20px;background:transparent;color:var(--muted);cursor:pointer;font-size:.85rem;transition:all .2s}
.filters button.active,.filters button:hover{background:var(--accent2);color:#fff;border-color:var(--accent2)}

.memories{display:flex;flex-direction:column;gap:12px}

.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px 20px;cursor:pointer;transition:border-color .2s}
.card:hover{border-color:var(--accent2)}
.card-top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
.card-text{flex:1;font-size:.95rem;line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical}
.card-meta{display:flex;gap:12px;align-items:center;margin-top:10px;flex-wrap:wrap}
.badge{padding:3px 10px;border-radius:12px;font-size:.75rem;font-weight:600;text-transform:uppercase}
.badge-fact{background:#065f46;color:#6ee7b7}
.badge-decision{background:#713f12;color:#fcd34d}
.badge-preference{background:#581c87;color:#c084fc}
.badge-entity{background:#164e63;color:#67e8f9}
.badge-event{background:#7c2d12;color:#fb923c}
.badge-lesson{background:#831843;color:#f9a8d4}
.importance{font-size:.8rem;color:var(--muted)}
.importance-bar{width:60px;height:6px;background:#333;border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle;margin-left:4px}
.importance-fill{height:100%;background:var(--accent2);border-radius:3px}
.date{font-size:.8rem;color:var(--muted)}
.score{font-size:.8rem;color:var(--accent);font-weight:600}
.access{font-size:.8rem;color:var(--muted)}

.card-actions{flex-shrink:0}
.btn-del{background:none;border:1px solid #7c2d12;color:#fb923c;padding:4px 10px;border-radius:6px;cursor:pointer;font-size:.8rem}
.btn-del:hover{background:#7c2d12}

.load-more{text-align:center;margin:20px 0}
.load-more button{padding:10px 32px;border:1px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text);cursor:pointer}
.load-more button:hover{border-color:var(--accent2)}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto;padding:24px}
.modal h2{margin-bottom:16px;font-size:1.2rem}
.modal .field{margin-bottom:12px}
.modal .field label{display:block;font-size:.8rem;color:var(--muted);margin-bottom:4px;text-transform:uppercase}
.modal .field .val{font-size:.95rem;line-height:1.5;white-space:pre-wrap}
.modal-close{float:right;background:none;border:none;color:var(--muted);font-size:1.5rem;cursor:pointer}

.empty{text-align:center;color:var(--muted);padding:60px 20px;font-size:1.1rem}
.spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent2);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:600px){.header{padding:12px 16px}.container{padding:12px}.search-bar{flex-direction:column}}
</style>
</head>
<body>
<div class="header">
  <h1>üß† Memory Explorer</h1>
  <div class="stats" id="stats">Loading...</div>
  <button onclick="window.location='/api/export'" style="padding:6px 14px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--muted);cursor:pointer;font-size:.85rem">üì• Export</button>
</div>
<div class="container">
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Semantic search memories..." />
    <button onclick="doSearch()">Search</button>
  </div>
  <div class="filters" id="filters">
    <button class="active" data-cat="">All</button>
    <button data-cat="fact">Fact</button>
    <button data-cat="decision">Decision</button>
    <button data-cat="preference">Preference</button>
    <button data-cat="entity">Entity</button>
    <button data-cat="event">Event</button>
    <button data-cat="lesson">Lesson</button>
  </div>
  <div class="memories" id="memories"></div>
  <div class="load-more" id="loadMore" style="display:none"><button onclick="loadMore()">Load More</button></div>
</div>

<div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modalContent"></div>
</div>

<script>
let currentCat = '';
let nextOffset = null;
let isSearch = false;

const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);

function badgeClass(cat){return 'badge badge-'+(cat||'fact')}
function fmtDate(d){if(!d)return'‚Äî';const dt=new Date(d);return dt.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'})}

async function api(url,opts={}){const r=await fetch(url,opts);return r.json()}

async function loadStats(){
  try{
    const d=await api('/api/stats');
    const count=d.points_count||d.vectors_count||0;
    $('#stats').textContent=`${count} memories`;
  }catch(e){$('#stats').textContent='Error loading stats'}
}

function renderCard(point, score){
  const p=point.payload||point;
  const id=point.id;
  const div=document.createElement('div');
  div.className='card';
  div.innerHTML=`
    <div class="card-top">
      <div class="card-text">${esc(p.text||'')}</div>
      <div class="card-actions"><button class="btn-del" onclick="event.stopPropagation();delMemory('${id}',this)">‚úï</button></div>
    </div>
    <div class="card-meta">
      <span class="${badgeClass(p.category)}">${esc(p.category||'unknown')}</span>
      <span class="importance">imp: ${((p.importance||0)*100).toFixed(0)}%<span class="importance-bar"><span class="importance-fill" style="width:${(p.importance||0)*100}%"></span></span></span>
      <span class="date">${fmtDate(p.createdAt)}</span>
      <span class="access">üëÅ ${p.accessCount||0}</span>
      ${score!=null?`<span class="score">score: ${score.toFixed(3)}</span>`:''}
    </div>`;
  div.onclick=()=>showModal(id,p,score);
  return div;
}

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

async function loadMemories(append=false){
  if(!append){$('#memories').innerHTML='<div class="empty"><span class="spinner"></span></div>';nextOffset=null}
  const params=new URLSearchParams({limit:'50'});
  if(nextOffset)params.set('offset',nextOffset);
  if(currentCat)params.set('category',currentCat);
  const data=await api('/api/memories?'+params);
  const points=data.points||[];
  if(!append)$('#memories').innerHTML='';
  if(!points.length&&!append){$('#memories').innerHTML='<div class="empty">No memories found</div>';$('#loadMore').style.display='none';return}
  points.sort((a,b)=>(b.payload?.createdAt||0)-(a.payload?.createdAt||0));
  points.forEach(p=>$('#memories').appendChild(renderCard(p)));
  nextOffset=data.next_page_offset||null;
  $('#loadMore').style.display=nextOffset?'block':'none';
}

function loadMore(){loadMemories(true)}

async function doSearch(){
  const q=$('#searchInput').value.trim();
  if(!q){isSearch=false;loadMemories();return}
  isSearch=true;
  $('#memories').innerHTML='<div class="empty"><span class="spinner"></span></div>';
  try{
    const data=await api('/api/search',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:q,limit:30})});
    const points=data.points||[];
    $('#memories').innerHTML='';
    if(!points.length){$('#memories').innerHTML='<div class="empty">No results</div>';return}
    points.forEach(p=>$('#memories').appendChild(renderCard(p,p.score)));
    $('#loadMore').style.display='none';
  }catch(e){$('#memories').innerHTML='<div class="empty">Search error: '+esc(e.message)+'</div>'}
}

$('#searchInput').addEventListener('keydown',e=>{if(e.key==='Enter')doSearch()});

async function delMemory(id,btn){
  if(!confirm('Delete this memory?'))return;
  btn.textContent='...';
  await api('/api/memories/'+id,{method:'DELETE'});
  btn.closest('.card').remove();
  loadStats();
}

function showModal(id,p,score){
  $('#modalContent').innerHTML=`
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <h2>Memory Details</h2>
    <div class="field"><label>ID</label><div class="val">${esc(id)}</div></div>
    <div class="field"><label>Text</label><div class="val">${esc(p.text||'')}</div></div>
    <div class="field"><label>Category</label><div class="val"><span class="${badgeClass(p.category)}">${esc(p.category||'')}</span></div></div>
    <div class="field"><label>Importance</label><div class="val">${((p.importance||0)*100).toFixed(0)}%</div></div>
    <div class="field"><label>Created</label><div class="val">${fmtDate(p.createdAt)}</div></div>
    <div class="field"><label>Last Accessed</label><div class="val">${fmtDate(p.lastAccessed)}</div></div>
    <div class="field"><label>Access Count</label><div class="val">${p.accessCount||0}</div></div>
    <div class="field"><label>Session Key</label><div class="val">${esc(p.sessionKey||'‚Äî')}</div></div>
    <div class="field"><label>Agent ID</label><div class="val">${esc(p.agentId||'‚Äî')}</div></div>
    ${score!=null?`<div class="field"><label>Relevance Score</label><div class="val">${score.toFixed(4)}</div></div>`:''}
  `;
  $('#modal').classList.add('active');
}
function closeModal(){$('#modal').classList.remove('active')}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()});

$$('.filters button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    $$('.filters button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentCat=btn.dataset.cat;
    isSearch=false;
    $('#searchInput').value='';
    loadMemories();
  });
});

loadStats();
loadMemories();
</script>
</body>
</html>
